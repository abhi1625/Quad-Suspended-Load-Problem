function [p, dp,d2p, d3p, d4p, f, phiL, dphiL,d2phiL,phiQ, dphiQ, d2phiQ] = diffFlatness1(t,mQ,mL,l,g)
    [xL_des,dxL_des, d2xL_des,d3xL_des,d4xL_des,d5xL_des,d6xL_des]=destraj(t);
    
    %derivatives of T,p, phiL and phiQ
    Tp = -(mL.*d2xL_des + (mL*g).*[0;1]);
    p = Tp./norm(Tp);
    phiL = atan2(Tp(1,1), -Tp(2,1)); 
    T = Tp(1,1)*sin(phiL) - Tp(2,1)*cos(phiL);
    
    dT = mL*(d2xL_des(1, 1)*d3xL_des(1, 1) + (d2xL_des(2, 1)+g)*d3xL_des(2, 1))*(d2xL_des(1, 1)^2+(d2xL_des(2, 1)+g)^2)^(-1/2);
    dp = -1./T.*(mL.*d3xL_des + dT.*p);
    dphiL = dp(1, 1)*cos(phiL) + dp(2, 1)*sin(phiL);

    %dT = mL*((d2xL_des(1,1)*d3xL_des(1, 1))+(d2xL_des(2,1)+g)*d3xL_des(2,1))*((d2xL_des(1,1)^2 + (d2xL_des(2,1) + g)^2)^(-0.5));
    %dp = -(1/T).*(mL.*d3xL_des + dT.*p);
    %dphiL = dp(1,1)*cos(phiL) + dp(2,1)*sin(phiL);
    
    d2T = mL*(( (d3xL_des(1, 1)^2+d2xL_des(1, 1)*d4xL_des(1, 1)+d4xL_des(2, 1)*(d2xL_des(2, 1)+g)+d3xL_des(2, 1)^2) * (d2xL_des(1, 1)^2+(d2xL_des(2, 1)+g)^2)^(-1/2) )...
        - ((d2xL_des(1, 1)*d3xL_des(1, 1)+(d2xL_des(2, 1)+g)*d3xL_des(2, 1))^2 * (d2xL_des(1, 1)^2+(d2xL_des(2, 1)+g)^2)^(-3/2) ) );
    d2p = -1./T.*(mL.*d4xL_des + d2T.*p + 2.*dT.*dp);
    d2phiL = d2p(1, 1)*cos(phiL) + d2p(2, 1)*sin(phiL);

    %d2T = mL*( ...
     %   ( (d3xL_des(1, 1)^2+d2xL_des(1, 1)*d4xL_des(1, 1)+d4xL_des(2, 1)*(d2xL_des(2, 1)+g)+d3xL_des(2, 1)^2) * (d2xL_des(1, 1)^2+(d2xL_des(2, 1)+g)^2)^(-1/2) )...
      %  - ( (d2xL_des(1, 1)*d3xL_des(1, 1)+(d2xL_des(2, 1)+g)*d3xL_des(2, 1))^2 * (d2xL_des(1, 1)^2+(d2xL_des(2, 1)+g)^2)^(-3/2) ) );
    %d2p = -(1/T).*(mL.*d4xL_des + d2T.*p + (2*dT).*dp);
    %d2phiL = d2p(1,1)*cos(phiL) + d2p(2,1)*sin(phiL);
    
    d3T = mL*(((3*d3xL_des(1,1)*d4xL_des(1,1) + d2xL_des(1,1)*d5xL_des(1,1) + (d2xL_des(2,1)+g)*d5xL_des(2,1) + 3*d3xL_des(2,1)*d4xL_des(2,1))*(d2xL_des(1,1)^2 + (d2xL_des(2,1)+g)^2)^(-0.5))+(3*((d2xL_des(1,1)^2 + (d2xL_des(2,1)+g)^2)^(-0.5))*(d2xL_des(1,1)*d3xL_des(1,1) + (d2xL_des(2,1)+g)*d3xL_des(2,1))*(d3xL_des(1,1)^2 + d2xL_des(1,1)*d4xL_des(1,1) + (d2xL_des(2,1)+g)*d4xL_des(2,1) + d3xL_des(2,1)^2))+(3*((d2xL_des(1,1)*d3xL_des(1,1) + (d2xL_des(2,1)+g)*d3xL_des(2,1))^3)*(d2xL_des(1,1)^2 +(d2xL_des(2,1)+g)^2)^(-2.5)));
    %d3T = mL*{ ((3*d3xL_des(1,1)*d4xL_des(1,1) + d2xL_des(1,1)*d5xL_des(1,1) + (d2xL_des(2,1)+g)*d5xL_des(2,1) + 3*d3xL_des(2,1)*d4xL_des(2,1))*(d2xL_des(1,1)^2 + (d2xL_des(2,1)+g)^2)^-0.5)...
   %     + (3*((d2xL_des(1,1)^2 + (d2xL_des(2,1)+g)^2)^-0.5)*(d2xL_des(1,1)*d3xL_des(1,1) + (d2xL_des(2,1)+g)*d3xL_des(2,1))*(d3xL_des(1,1)^2 + d2xL_des(1,1)*d4xL_des(1,1)+(d2xL_des(2,1)+g)*d4xL_des(2,1) + d3xL_des(2,1)^2))...
   %     + (3*(d2xL_des(1,1)*d3xL_des(1,1)+(d2xL_des(2,1)+g)*d3xL_des(2,1))^3)*((d2xL_des(1,1)^2 + (d2xL_des(2,1)+g)^2)^-2.5)};
    
    d3p = -1./T.*(mL.*d5xL_des + 3*d2T*dp + 3*dT*d2p + d3T*p);
    d3phiL = d3p(1, 1)*cos(phiL) + d3p(2, 1)*sin(phiL) + dphiL^3;

   %d3p = -(1/T).*(mL.*d5xL_des + (3*d2T).*dp + (3*dT).*d2p + d3T.*p);
    %d3phiL = d3p(1,1)*cos(phiL) + d3p(2,1)*sin(phiL) + dphiL^3;
    
    d4T = ( mL* ( ...
        - (15*(2*d3xL_des(2, 1)*(d2xL_des(2, 1)+g)+2*d3xL_des(1, 1)*d2xL_des(1, 1))^4) ...
        + (72*((d2xL_des(2, 1)+g)^2+d2xL_des(1, 1)^2)*(d4xL_des(2, 1)*(d2xL_des(2, 1)+g)+d3xL_des(1, 1)^2+d4xL_des(1, 1)*d2xL_des(1, 1)+d3xL_des(2, 1)^2)*(2*d3xL_des(2, 1)*(d2xL_des(2, 1)+g)+2*d3xL_des(1, 1)*d2xL_des(1, 1))^2) ...
        - (48*((d2xL_des(2, 1)+g)^2+d2xL_des(1, 1)^2)^2*(d4xL_des(2, 1)*(d2xL_des(2, 1)+g)+d3xL_des(1, 1)^2+d4xL_des(1, 1)*d2xL_des(1, 1)+d3xL_des(2, 1)^2)^2) ...
        - (16*((d2xL_des(2, 1)+g)^2+d2xL_des(1, 1)^2)^2*(2*d5xL_des(2, 1)*(d2xL_des(2, 1)+g)+2*d5xL_des(1, 1)*d2xL_des(1, 1)+6*d3xL_des(1, 1)*d4xL_des(1, 1)+6*d3xL_des(2, 1)*d4xL_des(2, 1))*(2*d3xL_des(2, 1)*(d2xL_des(2, 1)+g)+2*d2xL_des(1, 1)*d3xL_des(1, 1))) ...
        + (8*((d2xL_des(2, 1)+g)^2+d2xL_des(1, 1)^2)^3*(2*d6xL_des(2, 1)*(d2xL_des(2, 1)+g)+6*d4xL_des(1, 1)^2+2*d6xL_des(1, 1)*d2xL_des(1, 1)+8*d3xL_des(1, 1)*d5xL_des(1, 1)+6*d4xL_des(2, 1)^2+8*d3xL_des(2, 1)*d5xL_des(2, 1))) ) ...
        )*(16*((d2xL_des(2, 1)+g)^2+d2xL_des(1, 1)^2)^(7/2) )^(-1);
    
        %d4T1 = mL*((-15/8)*(((d2xL_des(2,1)+g)*d3xL_des(2,1) + d3xL_des(1,1)*d2xL_des(1,1))^4)*((d2xL_des(1,1)^2 + (d2xL_des(2,1)+g)^2)^-3.5)...
        %+ 9*((d2xL_des(1,1)*d3xL_des(1,1) + (d2xL_des(2,1)+g)*d3xL_des(2,1))^2)*((d2xL_des(2,1)+g)*d4xL_des(2,1) + d2xL_des(1,1)*d4xL_des(1,1) + d3xL_des(1,1)^2 + d3xL_des(2,1)^2)*(d2xL_des(1,1)^2 + (d2xL_des(2,1)+g)^2)^-2.5...
        %- 3*((d2xL_des(2,1)+g)*d4xL_des(2,1) + d2xL_des(1,1)*d4xL_des(1,1) + d3xL_des(1,1)^2 + d3xL_des(2,1)^2)*((d2xL_des(1,1)^2 + (d2xL_des(2,1)+g)^2)^-1.5)... 
        %- 4*((d2xL_des(2,1)+g)*d3xL_des(2,1) + d2xL_des(1,1)*d3xL_des(1,1))*((d2xL_des(2,1)+g)*d5xL_des(2,1) + d2xL_des(1,1)*d5xL_des(1,1) + 3*d4xL_des(1,1)*d3xL_des(1,1) + 3*d3xL_des(2,1)*d4xL_des(2,1))*(d2xL_des(1,1)^2 + (d2xL_des(2,1)+g)^2)^-1.5... 
        d4p = -1./T.*(mL.*d6xL_des + 4.*d3T.*dp + 6.*d2T.*d2p + 4.*dT.*d3p + d4T*p);
        %d4p = -(1/T).*(mL.*d6xL_des + (4*d3T).*dp + (6*d2T).*d2p + (4*dT).*d3p + d4T.*p);
    d4phiL = d4p(1, 1)*cos(phiL) + d4p(2, 1)*sin(phiL) + 6*dphiL^2*d2phiL;  
    %d4phiL = d4p(1,1)*cos(phiL) + d4p(2,1)*sin(phiL) + 6*d2phiL*dphiL^2 ;
    
    fa3 = ((mQ+mL).*(d2xL_des + g.*[0;1])) - (mQ*l).*d2p;
    phiQ = atan2(-fa3(1,1),fa3(2,1));
    f = -fa3(1,1)*sin(phiQ) + fa3(2,1)*cos(phiQ);
    
    dphiQ = (((l*mQ*d3p(1, 1)-(mQ+mL)*d3xL_des(1, 1)) * ((mQ+mL)*(d2xL_des(2, 1)+g)-l*mQ*d2p(2, 1))) ...
        + ((l*mQ*d3p(2, 1)-(mQ+mL)*d3xL_des(2, 1)) * (l*mQ*d2p(1, 1)-(mQ+mL)*d2xL_des(1, 1))) ) ...
        * ((l*mQ*d2p(2, 1)-(mQ+mL)*(d2xL_des(2, 1)+g))^2 * ((l*mQ*d2p(1, 1)-(mQ+mL)*d2xL_des(1, 1))^2/((l*mQ*d2p(2, 1)-(mQ+mL)*(d2xL_des(2, 1)+g))^2) + 1) )^-1;
   
    
    %dphiQ1 = (((l*mQ*d3p(1,1) - (mQ+mL)*d3xL_des(1,1))*((mQ+mL)*(d2xL_des(2,1)+g) - l*mQ*d2p(2,1))) + ((l*mQ*d3p(2,1) - (mQ+mL)*d3xL_des(2,1))*(l*mQ*d2p(1,1) - (mQ+mL)*d2xL_des(1,1)))*(((l*mQ*d2p(2,1) - (mQ+mL)*(d2xL_des(2,1)))^2)*(((l*mQ*d2p(1,1) - (mQ+mL)*d2xL_des(1,1))^2 /(l*mQ*d2p(2,1) +(mQ+mL)*d2xL_des(2,1))^2) + 1))^-1) ;
    
    
    d2phiQ = ((((l*mQ*d4p(1, 1)-(mQ+mL)*d4xL_des(1, 1))*((mQ+mL)*(d2xL_des(2, 1)+g)-l*mQ*d2p(2, 1))^(-1)) ...
             -(2*(l*mQ*d3p(1, 1)-(mQ+mL)*d3xL_des(1, 1))*((mQ+mL)*d3xL_des(2, 1)-l*mQ*d3p(2, 1))*((mQ+mL)*(d2xL_des(2, 1)+g)-l*mQ*d2p(2, 1))^(-2)) ...
             -(((mQ+mL)*d4xL_des(2, 1)-l*mQ*d4p(2, 1))*(l*mQ*d2p(1, 1)-(mQ+mL)*d2xL_des(1, 1))*((mQ+mL)*(d2xL_des(2, 1)+g)-l*mQ*d2p(2, 1))^(-2)) ...
             +(2*((mQ+mL)*d3xL_des(2, 1)-l*mQ*d3p(2, 1))^2*(l*mQ*d2p(1, 1)-(mQ+mL)*d2xL_des(1, 1))*((mQ+mL)*(d2xL_des(2, 1)+g)-l*mQ*d2p(2, 1))^(-3)) ) ...
             * ((((l*mQ*d2p(1, 1)-(mQ+mL)*d2xL_des(1, 1))^2*((mQ+mL)*(d2xL_des(2, 1)+g)-l*mQ*d2p(2, 1))^(-2))+1)^(-1) ) ...
             ) - (((2*(l*mQ*d3p(1, 1)-(mQ+mL)*d3xL_des(1, 1))*(l*mQ*d2p(1, 1)-(mQ+mL)*d2xL_des(1, 1))*((mQ+mL)*(d2xL_des(2, 1)+g)-l*mQ*d2p(2, 1))^(-2)) ...
             -(2*((mQ+mL)*d3xL_des(2, 1)-l*mQ*d3p(2, 1))*(l*mQ*d2p(1, 1)-(mQ+mL)*d2xL_des(1, 1))^2*((mQ+mL)*(d2xL_des(2, 1)+g)-l*mQ*d2p(2, 1))^(-3)) ) ...
             * (((l*mQ*d3p(1, 1)-(mQ+mL)*d3xL_des(1, 1))*((mQ+mL)*(d2xL_des(2, 1)+g)-l*mQ*d2p(2, 1))^(-1)) ...
             -(((mQ+mL)*d3xL_des(2, 1)-l*mQ*d3p(2, 1))*(l*mQ*d2p(1, 1)-(mQ+mL)*d2xL_des(1, 1))*((mQ+mL)*(d2xL_des(2, 1)+g)-l*mQ*d2p(2, 1))^(-2)) ) ...
             * (((l*mQ*d2p(1, 1)-(mQ+mL)*d2xL_des(1, 1))^2*((mQ+mL)*(d2xL_des(2, 1)+g)-l*mQ*d2p(2, 1))^(-2))+1)^(-2) );

    %d2phiQ1 = (((((l*mQ*d4p(1,1) - (mQ+mL)*d4xL_des(1,1))/(mQ+mL)*((d2xL_des(2,1)+g)-l*mQ*d2p(2,1))) - ((2*(l*mQ*d3p(1,1) - (mQ+mL)*d3xL_des(1,1))*((mQ+mL)*d3xL_des(2,1) - l*mQ*d3p(2,1)))/((mQ+mL)*(d2xL_des(2,1)+g) - l*mQ*d2p(2,1))^2)...
     %   -(((mQ+mL)*d4xL_des(2,1) - l*mQ*d4p(2,1))*(l*mQ*d2p(1,1)-(mQ+mL)*d2xL_des(1,1))/((mQ+mL)*(d2xL_des(2,1)+g) - l*mQ*d2p(2,1))^2) + ((2*(((mQ+mL)*d3xL_des(2,1)-l*mQ*d3p(1,1))^2)*(l*mQ*d2p(1,1)-(mQ+mL)*d2xL_des(1,1)))/((mQ+mL)*(d2xL_des(2,1)+g) - l*mQ*d2p(2,1))^3))*(((l*mQ*d2p(1,1) - (mQ+mL)*d2xL_des(1,1))^2)/((((mQ+mL)*(d2xL_des(2,1)+g) - l*mQ*d2p(2,1))^2) +1)^(-1)))...
      %  -((((2*(l*mQ*d3p(1,1) - (mQ+mL)*d3xL_des(1,1))*(l*mQ*d2p(1,1) - (mQ+mL)*d2xL_des(1,1)))/(((mQ+mL)*(d2xL_des(2,1)+g) - l*mQ*d2p(2,1)^2))) - ((2*((mQ+mL)*d3xL_des(2,1)) - mQ*l*d3p(2,1))*(l*mQ*d2p(1,1) - (mQ+mL)*d2xL_des(1,1))^2)/((mQ+mL)*(d2xL_des(2,1)+g) - l*mQ*d2p(2,1))^3)*(((l*mQ*d3p(1,1) - (mQ+mL)*d3xL_des(1,1))/((mQ+mL)*(d2xL_des(2,1)+g) - l*mQ*d2p(2,1))^2) - (((mQ+mL)*d3xL_des(2,1) - l*mQ*d3p(2,1))*(l*mQ*d2p(1,1) - (mQ+mL)*d2xL_des(1,1))^2)/((mQ+mL)*(d2xL_des(2,1)+g) - l*mQ*d2p(2,1))^2)*(((l*mQ*d2p(1,1) - (mQ+mL)*d2xL_des(1,1))^2/((mQ+mL)*(d2xL_des(2,1)+g) - l*mQ*d2p(2,1))^2)+1)^-2));
    
end
    
    
    
    
    
    
    
    